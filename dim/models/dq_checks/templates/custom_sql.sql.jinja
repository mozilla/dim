
WITH CTE AS (
    {{sql}}
),

CTE2 AS (
SELECT TO_JSON_STRING(STRUCT(TO_JSON_STRING(CTE) AS additional_information, '''{{ sql }}''' AS sql))  as additional_information
FROM CTE
WHERE  {{ threshold }}
)

SELECT *, "{{ project_id }}" as project_id,
"{{ dataset_id }}" as dataset_id,
"{{ table_id }}" as table_id,
"{{ dq_check }}" as dq_check, 
"{{ dataset_owner }}" as dataset_owner,
"{{ slack_alert }}" as slack_alert,
CURRENT_DATE() as created_date
FROM CTE2
