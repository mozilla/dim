WITH CTE AS (
    SELECT
        {% for column in params.columns %}(COUNT(*) - COUNT(DISTINCT {{ column }})) AS {{ column }}_duplicate_count,{% endfor %}
    FROM `{{ project_id }}.{{ dataset }}.{{ table }}`
    WHERE
        date_partition = DATE('{{ params.partition }}')
    GROUP BY{% for column in params.columns %}
        {{ column }}{{ ',' if not loop.last else '' }}{% endfor %}
    HAVING COUNT(*) > 1
)

SELECT
    '{{ project_id }}' AS project_id,
    '{{ dataset }}' AS dataset,
    '{{ table }}' AS table,
    '{{ dq_check }}' AS dq_check,
    DATE('{{ params.partition }}') AS date_partition,
    CURRENT_DATETIME() AS actual_run_date,
    '{{ params.owner }}' AS owner,
    CAST('{{ params.alert_enabled }}' AS BOOL) AS alert_enabled,
    CAST('{{ params.alert_muted }}' AS BOOL) AS alert_muted,
    TO_JSON_STRING(CTE) AS additional_information,
    '{{ params.run_id }}' AS run_id,
    IF({% for column in params.columns %}{{ column }}_duplicate_count{{ "" if loop.last else " + " }}{% endfor %} > 0, False, True) AS passed,
FROM CTE